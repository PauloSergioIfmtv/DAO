unit PessoasDAO;

interface

uses Windows, Messages, SysUtils, SqlExpr, Dialogs, Forms, StrUtils,
  PessoasEN, Data.DB, DBClient, System.Classes;

type
  TPessoasDAO = class(TPessoasEN)
  private
    { Private declarations }
    pocdsPessoas: TClientDataSet;
    podsPessoas: TDataSource;
    procedure createFieldsDefcdsPessoas;
  protected
    { Protected declarations }
  published
    { published declarations }
    procedure getDados;
    function gravarDados: Boolean;
  public
    { Public declarations }
    constructor Create;
    destructor Destroy; override;
    property ocdsPessoas: TClientDataSet read pocdsPessoas write pocdsPessoas;
    property odsPessoas: TDataSource read podsPessoas write podsPessoas;
  end;

implementation

{ TPessoasDAO }

constructor TPessoasDAO.Create;
begin
  inherited Create;
  TPessoasEN.Create;

  ocdsPessoas := TClientDataSet.Create(Application);
  odsPessoas := TDataSource.Create(Application);
  odsPessoas.DataSet := ocdsPessoas;
  createFieldsDefcdsPessoas;
end;

procedure TPessoasDAO.createFieldsDefcdsPessoas;
begin
  ocdsPessoas.FieldDefs.Clear;
  ocdsPessoas.FieldDefs.Add('Nome', ftString, 120);
  ocdsPessoas.FieldDefs.Add('Identidade', ftString, 20);
  ocdsPessoas.FieldDefs.Add('CPFCNPJ', ftString, 14);
  ocdsPessoas.FieldDefs.Add('Telefone', ftString, 12);
  ocdsPessoas.FieldDefs.Add('Email', ftString, 150);
  ocdsPessoas.FieldDefs.Add('CEP', ftString, 8);
  ocdsPessoas.FieldDefs.Add('Logradouro', ftString, 120);
  ocdsPessoas.FieldDefs.Add('Numero', ftString, 60);
  ocdsPessoas.FieldDefs.Add('Complemento', ftString, 120);
  ocdsPessoas.FieldDefs.Add('Bairro', ftString, 120);
  ocdsPessoas.FieldDefs.Add('Cidade', ftString, 120);
  ocdsPessoas.FieldDefs.Add('Estado', ftString, 120);
  ocdsPessoas.FieldDefs.Add('Pais', ftString, 100);

end;

destructor TPessoasDAO.Destroy;
begin
  inherited Destroy;
end;

procedure TPessoasDAO.getDados;
var
  lsPessoas: TStringList;
  lnIndex: Integer;
  lsRow: TStringList;
  lsTexto: String;
begin
  if FileExists(ExtractFilePath(Application.ExeName)+'PessoasCad.txt') then
  begin
    lsPessoas := TStringList.Create;
    lsRow := TStringList.Create;
    lsPessoas.LoadFromFile(ExtractFilePath(Application.ExeName)+'PessoasCad.txt');

    if pocdsPessoas.Active then
      pocdsPessoas.Close;
    pocdsPessoas.CreateDataSet;

    for lnIndex := 0 to lsPessoas.Count -1 do
    begin
      lsTexto := lsPessoas[lnIndex];
      lsRow.Clear;
      ExtractStrings([';'], [], PChar(lsTexto), lsRow);

      pocdsPessoas.Insert;
      pocdsPessoas.FieldByName('Nome').AsString := lsRow[0];
      pocdsPessoas.FieldByName('Identidade').AsString := lsRow[1];
      pocdsPessoas.FieldByName('CPFCNPJ').AsString := lsRow[2];
      pocdsPessoas.FieldByName('Telefone').AsString := lsRow[3];
      pocdsPessoas.FieldByName('Email').AsString := lsRow[4];
      pocdsPessoas.FieldByName('CEP').AsString := lsRow[5];
      pocdsPessoas.FieldByName('Logradouro').AsString := lsRow[6];
      pocdsPessoas.FieldByName('Numero').AsString := lsRow[7];
      pocdsPessoas.FieldByName('Complemento').AsString := lsRow[8];
      pocdsPessoas.FieldByName('Bairro').AsString := lsRow[9];
      pocdsPessoas.FieldByName('Cidade').AsString := lsRow[10];
      pocdsPessoas.FieldByName('Estado').AsString := lsRow[11];
      pocdsPessoas.FieldByName('Pais').AsString := lsRow[12];
      pocdsPessoas.Post;
    end;
  end;
end;

function TPessoasDAO.gravarDados: Boolean;
var
  llResult: Boolean;
  lsText: TextFile;
  lsDados: String;
begin
  llResult := True;

  if pocdsPessoas.Active then
    if pocdsPessoas.RecordCount > 0 then
    begin
      if FileExists(ExtractFilePath(Application.ExeName)+'PessoasCad.txt') then
        DeleteFile(ExtractFilePath(Application.ExeName)+'PessoasCad.txt');

      AssignFile(lsText, ExtractFilePath(Application.ExeName)+'PessoasCad.txt');
      ReWrite(lsText);
      pocdsPessoas.First;
      while not pocdsPessoas.Eof do
      begin
        lsDados := Trim(pocdsPessoas.FieldByName('Nome').AsString) + ' ;' +
          Trim(pocdsPessoas.FieldByName('Identidade').AsString) + ' ;' +
          Trim(pocdsPessoas.FieldByName('CPFCNPJ').AsString) + ' ;' +
          Trim(pocdsPessoas.FieldByName('Telefone').AsString) + ' ;' +
          Trim(pocdsPessoas.FieldByName('Email').AsString) + ' ;' +
          Trim(pocdsPessoas.FieldByName('CEP').AsString) + ' ;' +
          Trim(pocdsPessoas.FieldByName('Logradouro').AsString) + ' ;' +
          Trim(pocdsPessoas.FieldByName('Numero').AsString) + ' ;' +
          Trim(pocdsPessoas.FieldByName('Complemento').AsString) + ' ;' +
          Trim(pocdsPessoas.FieldByName('Bairro').AsString) + ' ;' +
          Trim(pocdsPessoas.FieldByName('Cidade').AsString) + ' ;' +
          Trim(pocdsPessoas.FieldByName('Estado').AsString) + ' ;' +
          Trim(pocdsPessoas.FieldByName('Pais').AsString);

        ShowMessage(lsDados);
        WriteLn(lsText, lsDados);

        pocdsPessoas.Next;
      end;

      pocdsPessoas.First;

      llResult := FileExists(ExtractFilePath(Application.ExeName)+'PessoasCad.txt');
    end;

  Result := llResult;
end;

end.
