unit UtilsDAO;

interface

uses System.SysUtils, System.Classes, Data.DBXJSON, DBXJSONReflect,
  idHTTP, IdSSLOpenSSL, System.JSon;

type
  TUtilsDAO = Class
    private
    { Private declarations }
    public
    { Public declarations }
      Constructor Create;
      Destructor Destroy;
      class function returnSoNumeros(Value: String): String;
      class function getCEP(CEP: String): TJsonObject;
      class function seachSiglaEstadoUF(Value: String): String;
  End;

implementation

{ TUtilsDAO }

constructor TUtilsDAO.Create;
begin
  inherited Create;
end;

destructor TUtilsDAO.Destroy;
begin
  inherited;
end;

class function TUtilsDAO.getCEP(CEP: String): TJsonObject;
var
  loHTTP: TIdHTTP;
  lsResponse: TStringStream;
begin
  try
    loHTTP := TIdHTTP.Create;
    loHTTP.IOHandler := IdSSLOpenSSL.TIdSSLIOHandlerSocketOpenSSL.Create;
    lsResponse := TStringStream.Create(EmptyStr);

    loHTTP.Get('https://viacep.com.br/ws/' + CEP + '/json', lsResponse);
    if (loHTTP.ResponseCode = 200) and not (UTF8ToString(lsResponse.DataString) = '{'#$A'  "erro": true'#$A'}') then
      Result := TJSONObject.ParseJSONValue(TEncoding.ASCII.GetBytes(UTF8ToString(lsResponse.DataString)), 0) as TJSONObject
    else
      raise Exception.Create('CEP inexistente!');

  finally
    FreeAndNil(loHTTP);
    lsResponse.Destroy;
  end;
end;

class function TUtilsDAO.returnSoNumeros(Value: String): String;
var
  lnIndex: Integer;
  lsResult: String;
  lcNumeros: TSysCharSet;
begin
  lcNumeros := ['0'..'9'];
  lsResult := EmptyStr;

  if Value.Trim <> EmptyStr then
  begin
    for lnIndex := 0 to Length(Value) do
    begin
      if CharInSet(Value[lnIndex], lcNumeros) then
        lsResult := lsResult + Value[lnIndex];
    end;
  end;

  Result := lsResult;
end;

class function TUtilsDAO.seachSiglaEstadoUF(Value: String): String;
var
  lsResult: String;
begin
  lsResult := EmptyStr;
  case Value of
    'AC': lsResult := 'Acre';
    'AL': lsResult := 'Alagoas';
    'AM': lsResult := 'Amazonas';
    'AP': lsResult := 'Amapá';
    'BA': lsResult := 'Bahia';
    'CE': lsResult := 'Ceará';
    'DF': lsResult := 'Distrito Federal';
    'ES': lsResult := 'Espiríto Santo';
    'GO': lsResult := 'Goiás';
    'MA': lsResult := 'Maranhão';
    'MG': lsResult := 'Minas Gerais';
    'MS': lsResult := 'Mato Grosso do Sul';
    'MT': lsResult := 'Mato Grosso';
    'PA': lsResult := 'Pará';
    'PB': lsResult := 'Paraíba';
    'RJ': lsResult := 'Rio de Janeiro';
    'RN': lsResult := 'Rio Grande do Norte';
    'RS': lsResult := 'Rio Grande do Sul';
    'RR': lsResult := 'Rondônia';
    'RO': lsResult := 'Roraima';
    'SC': lsResult := 'Santa Catarina';
    'SE': lsResult := 'Sergipe';
    'SP': lsResult := 'São Paulo';
    'TO': lsResult := 'Tocantins';
  end;
end;

end.
